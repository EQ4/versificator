import time
import random
random.seed(time.time())
import os
import OSC
import requests
import settings
import soundcloud
import traceback
import logging
import numpy as np
logger = logging.getLogger('versificator')
# Less log messages from requests
requests_log = logging.getLogger('requests')
requests_log.setLevel(logging.WARNING)

from pychedelic import Sound


def get_sound():
    """
    Downloads a random sound from soundcloud, saves it and returns 
    the filename and the sound length in seconds.
    """
    global count
    count = (count + 1) % len(mp3s)
    return random.randint(0, 100000), '/home/spiq/versificator/downloads/' + mp3s[count], 120.0

    #return random.randint(0, 100000), '/home/spiq/versificator/downloads/54691.mp3', 60
    # create a client object with your app credentials
    client = soundcloud.Client(client_id='YOUR_CLIENT_ID')
    track, resp = None, None
    while (True):
        # Get a random track
        while (True):
            track_id = random.randint(0, 100000)
            try:
                track = client.get('/tracks/%s' % track_id)
            except requests.exceptions.HTTPError as exc:
                if exc.response.status_code != 404: logger.error(exc)
                else: logger.debug('%s - %s' % (exc, track_id))
                continue
            else: break

        # Downloading track.
        # We don't want too long tracks because of memory pbs.
        sound_length = track.duration
        if sound_length > 60 * 5000: continue
        if not hasattr(track, 'stream_url'): continue
        track_stream = client.get(track.stream_url, allow_redirects=False)
        logger.info('downloading track %s' % track.stream_url)
        resp = requests.get(track_stream.location)
        if resp.status_code == 200:
            filename = settings.app_root + 'downloads/%s.mp3' % track_id
            logger.info('saving track to %s' % filename)
            try:
                with open(filename, 'wb') as fd:
                    for chunk in resp.iter_content(64 * 1024):
                        fd.write(chunk)
            except Exception as exc:
                logger.error('file download failed : %s' % exc)
                continue
        else:
            logger.error('tried to download track, but got %s' % resp)
            continue
        return track_id, filename, sound_length / 1000.0


def euclidian_distance(a, b):
    return np.linalg.norm(np.array(a) - np.array(b))


def loop_distance(loop_infos1, loop_infos2):
    """
    Simple measure of the timbral distance between end of loop1 and start of loop2.
    """
    return euclidian_distance(loop_infos1['timbre_start'], loop_infos2['timbre_end'])


def send_msg(address, *args):
    client = OSC.OSCClient()
    client.connect(('localhost', 9001))
    msg = OSC.OSCMessage(address)
    for arg in args:
        msg.append(arg)
    client.send(msg)

# DEBUGGING
count = -1
mp3s = [
'14526.mp3',
 '67471.mp3',
 '51404.mp3',
 '83080.mp3',
 '84252.mp3',
 '64423.mp3',
 '726.mp3',
 '6196.mp3',
 '55944.mp3',
 '17125.mp3',
 '68593.mp3',
 '1054.mp3',
 '17225.mp3',
 '88666.mp3',
 '15571.mp3',
 '74794.mp3',
 '21709.mp3',
 '92298.mp3',
 '40806.mp3',
 '65885.mp3',
 '40291.mp3',
 '77907.mp3',
 '37155.mp3',
 '83446.mp3',
 '18567.mp3',
 '45743.mp3',
 '92286.mp3',
 '6411.mp3',
 '38838.mp3',
 '85976.mp3',
 '16550.mp3',
 '82825.mp3',
 '70941.mp3',
 '25331.mp3',
 '61995.mp3',
 '81082.mp3',
 '83164.mp3',
 '31273.mp3',
 '89381.mp3',
 '80806.mp3',
 '56104.mp3',
 '57676.mp3',
 '39075.mp3',
 '27670.mp3',
 '30235.mp3',
 '30248.mp3',
 '16996.mp3',
 '45665.mp3',
 '43882.mp3',
 '60427.mp3',
 '95695.mp3',
 '30161.mp3',
 '10778.mp3',
 '91327.mp3',
 '65636.mp3',
 '45055.mp3',
 '16040.mp3',
 '65369.mp3',
 '28685.mp3',
 '37538.mp3',
 '81020.mp3',
 '93188.mp3',
 '10560.mp3',
 '47422.mp3',
 '21864.mp3',
 '81046.mp3',
 '39535.mp3',
 '11434.mp3',
 '10403.mp3',
 '12066.mp3',
 '71803.mp3',
 '24906.mp3',
 '69352.mp3',
 '77354.mp3',
 '60318.mp3',
 '2944.mp3',
 '93467.mp3',
 '90145.mp3',
 '61576.mp3',
 '14516.mp3',
 '90949.mp3',
 '13840.mp3',
 '52864.mp3',
 '60017.mp3',
 '12381.mp3',
 '73501.mp3',
 '60420.mp3',
 '97174.mp3',
 '11609.mp3',
 '76347.mp3',
 '95881.mp3',
 '71058.mp3',
 '75080.mp3',
 '64184.mp3',
 '18235.mp3',
 '49897.mp3',
 '16441.mp3',
 '3936.mp3',
 '48257.mp3',
 '20843.mp3',
 '9569.mp3',
 '31299.mp3',
 '93776.mp3',
 '83441.mp3',
 '58030.mp3',
 '46763.mp3',
 '11345.mp3',
 '21863.mp3',
 '93801.mp3',
 '50578.mp3',
 '86373.mp3',
 '28469.mp3',
 '13261.mp3',
 '31624.mp3',
 '63838.mp3',
 '11843.mp3',
 '60941.mp3',
 '56120.mp3',
 '42262.mp3',
 '93749.mp3',
 '37742.mp3',
 '80243.mp3',
 '85461.mp3',
 '19820.mp3',
 '83964.mp3',
 '41247.mp3',
 '50301.mp3',
 '46188.mp3',
 '41758.mp3',
 '50791.mp3',
 '37553.mp3',
 '6902.mp3',
 '99271.mp3',
 '95777.mp3',
 '95671.mp3',
 '49809.mp3',
 '43389.mp3',
 '39269.mp3',
 '36349.mp3',
 '35928.mp3',
 '65062.mp3',
 '49068.mp3',
 '97354.mp3',
 '12951.mp3',
 '52362.mp3',
 '76276.mp3',
 '3759.mp3',
 '12295.mp3',
 '11301.mp3',
 '40730.mp3',
 '48685.mp3',
 '22121.mp3',
 '48766.mp3',
 '17439.mp3',
 '461.mp3',
 '25732.mp3',
 '75654.mp3',
 '97608.mp3',
 '52176.mp3',
 '82819.mp3',
 '14524.mp3',
 '95144.mp3',
 '47833.mp3',
 '19015.mp3',
 '9930.mp3',
 '85823.mp3',
 '80423.mp3',
 '65574.mp3',
 '81164.mp3',
 '86138.mp3',
 '36434.mp3',
 '54506.mp3',
 '38910.mp3',
 '55587.mp3',
 '93286.mp3',
 '64181.mp3',
 '43254.mp3',
 '40493.mp3',
 '56552.mp3',
 '52405.mp3',
 '52067.mp3',
 '49306.mp3',
 '15067.mp3',
 '44085.mp3',
 '5302.mp3',
 '7790.mp3',
 '23168.mp3',
 '85641.mp3',
 '13280.mp3',
 '39347.mp3',
 '68429.mp3',
 '62517.mp3',
 '28979.mp3',
 '2761.mp3',
 '64119.mp3',
 '79856.mp3',
 '20093.mp3',
 '38348.mp3',
 '54048.mp3',
 '63602.mp3',
 '4237.mp3',
 '48379.mp3',
 '88405.mp3',
 '97339.mp3',
 '23419.mp3',
 '43176.mp3',
 '11613.mp3',
 '92371.mp3',
 '35544.mp3',
 '89988.mp3',
 '34691.mp3',
 '24698.mp3',
 '56099.mp3',
 '27888.mp3',
 '51825.mp3',
 '75874.mp3',
 '13409.mp3',
 '14523.mp3',
 '32790.mp3',
 '58425.mp3',
 '64625.mp3',
 '12208.mp3',
 '70238.mp3',
 '38152.mp3',
 '8520.mp3',
 '12329.mp3',
 '79188.mp3',
 '16005.mp3',
 '69467.mp3',
 '82247.mp3',
 '84877.mp3',
 '58741.mp3',
 '34851.mp3',
 '68792.mp3',
 '8679.mp3',
 '50260.mp3',
 '40485.mp3',
 '79820.mp3',
 '65358.mp3',
 '76408.mp3',
 '85138.mp3',
 '48200.mp3',
 '58220.mp3',
 '51299.mp3',
 '50621.mp3',
 '31800.mp3',
 '26044.mp3',
 '43343.mp3',
 '21817.mp3',
 '54137.mp3',
 '25560.mp3',
 '21342.mp3',
 '15949.mp3',
 '68808.mp3',
 '11404.mp3',
 '85829.mp3',
 '41312.mp3',
 '55495.mp3',
 '94824.mp3',
 '27339.mp3',
 '34878.mp3',
 '36449.mp3',
 '91561.mp3',
 '68281.mp3',
 '50914.mp3',
 '12345.mp3',
 '25133.mp3',
 '40643.mp3',
 '4888.mp3',
 '28675.mp3',
 '12519.mp3',
 '156.mp3',
 '9714.mp3',
 '43757.mp3',
 '54801.mp3',
 '32157.mp3',
 '52586.mp3',
 '54084.mp3',
 '79717.mp3',
 '51537.mp3',
 '73774.mp3',
 '83232.mp3',
 '76482.mp3',
 '11850.mp3',
 '88124.mp3',
 '42769.mp3',
 '14045.mp3',
 '34648.mp3',
 '68048.mp3',
 '79357.mp3',
 '14134.mp3',
 '52210.mp3',
 '12813.mp3',
 '68839.mp3',
 '71959.mp3',
 '39034.mp3',
 '18584.mp3',
 '60097.mp3',
 '29022.mp3',
 '67159.mp3',
 '4296.mp3',
 '82383.mp3',
 '20861.mp3',
 '15380.mp3',
 '78298.mp3',
 '63984.mp3',
 '82413.mp3',
 '11366.mp3',
 '26079.mp3',
 '48653.mp3',
 '37417.mp3',
 '52839.mp3',
 '3504.mp3',
 '28390.mp3',
 '59013.mp3',
 '96949.mp3',
 '7949.mp3',
 '46509.mp3',
 '73619.mp3',
 '16844.mp3',
 '37792.mp3',
 '51846.mp3',
 '11537.mp3',
 '57795.mp3',
 '76985.mp3',
 '86908.mp3',
 '22918.mp3',
 '50902.mp3',
 '82775.mp3',
 '67143.mp3',
 '45177.mp3',
 '60926.mp3',
 '99317.mp3',
 '85449.mp3',
 '21861.mp3',
 '45736.mp3',
 '34706.mp3',
 '56234.mp3',
 '31724.mp3',
 '5092.mp3',
 '74744.mp3',
 '77898.mp3',
 '94571.mp3',
 '94871.mp3',
 '41295.mp3',
 '32010.mp3',
 '26973.mp3',
 '36162.mp3',
 '7303.mp3',
 '40102.mp3',
 '35502.mp3',
 '88507.mp3',
 '72476.mp3',
 '28530.mp3',
 '90858.mp3',
 '52921.mp3',
 '97079.mp3',
 '45735.mp3',
 '16078.mp3',
 '36590.mp3',
 '88538.mp3',
 '81006.mp3',
 '57404.mp3',
 '70421.mp3',
 '10481.mp3',
 '99133.mp3',
 '38159.mp3',
 '65784.mp3',
 '11787.mp3',
 '16751.mp3',
 '68237.mp3',
 '68990.mp3',
 '4094.mp3',
 '18342.mp3',
 '7429.mp3',
 '60591.mp3',
 '88007.mp3',
 '428.mp3',
 '31067.mp3',
 '68177.mp3',
 '82309.mp3',
 '51618.mp3',
 '24412.mp3',
 '80701.mp3',
 '8808.mp3',
 '83932.mp3',
 '35426.mp3',
 '35409.mp3',
 '50631.mp3',
 '36328.mp3',
 '47784.mp3',
 '83606.mp3',
 '90054.mp3',
 '43422.mp3',
 '67651.mp3',
 '22949.mp3',
 '84641.mp3',
 '52099.mp3',
 '45970.mp3',
 '76797.mp3',
 '43518.mp3',
 '5595.mp3',
 '37696.mp3',
 '94295.mp3',
 '55929.mp3',
 '39081.mp3',
 '10570.mp3',
 '29238.mp3',
 '33541.mp3',
 '76429.mp3',
 '2716.mp3',
 '60774.mp3',
 '15394.mp3',
 '52220.mp3',
 '74685.mp3',
 '12376.mp3',
 '5250.mp3',
 '12409.mp3',
 '12275.mp3',
 '43321.mp3',
 '81947.mp3',
 '65737.mp3',
 '85175.mp3',
 '94090.mp3',
 '22826.mp3',
 '16894.mp3',
 '29057.mp3',
 '25227.mp3',
 '86203.mp3',
 '77461.mp3',
 '11848.mp3',
 '41283.mp3',
 '76378.mp3',
 '25033.mp3',
 '20631.mp3',
 '33071.mp3',
 '16335.mp3',
 '52969.mp3',
 '97080.mp3',
 '24916.mp3',
 '17384.mp3',
 '40251.mp3',
 '41654.mp3',
 '45476.mp3',
 '70087.mp3',
 '44067.mp3',
 '47805.mp3',
 '10868.mp3',
 '11088.mp3',
 '47278.mp3',
 '82404.mp3',
 '51291.mp3',
 '71684.mp3',
 '78573.mp3',
 '19617.mp3',
 '68667.mp3',
 '56589.mp3',
 '3046.mp3',
 '31891.mp3',
 '23817.mp3',
 '37335.mp3',
 '84197.mp3',
 '51338.mp3',
 '54087.mp3',
 '35485.mp3',
 '97337.mp3',
 '41454.mp3',
 '54584.mp3',
 '35627.mp3',
 '77125.mp3',
 '43262.mp3',
 '61338.mp3',
 '51926.mp3',
 '36594.mp3',
 '53086.mp3',
 '17749.mp3',
 '16433.mp3',
 '52200.mp3',
 '31047.mp3',
 '12240.mp3',
 '47424.mp3',
 '38539.mp3',
 '47019.mp3',
 '86411.mp3',
 '77661.mp3',
 '48384.mp3',
 '70385.mp3',
 '32494.mp3',
 '73792.mp3',
 '36864.mp3',
 '65076.mp3',
 '58228.mp3',
 '35776.mp3',
 '58160.mp3',
 '16195.mp3',
 '13898.mp3',
 '71122.mp3',
 '92760.mp3',
 '81743.mp3',
 '10489.mp3',
 '81748.mp3',
 '36131.mp3',
 '26398.mp3',
 '63636.mp3',
 '96352.mp3',
 '14277.mp3',
 '36507.mp3']
